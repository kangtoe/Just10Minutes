# 적 스폰 시스템

> **관련 설계 문서**: [TimeBasedBudgetSpawnSystem.md](TimeBasedBudgetSpawnSystem.md)

## 개요

Vampire Survivors 스타일의 시간 기반 스폰 시스템으로, 예산 누적과 동적 난이도 조정이 결합된 시스템입니다.

---

## Phase 1: 기본 프레임워크

### 목표
시간 기반 스폰 시스템의 핵심 구조를 구축합니다.

### 구현 항목
- **시간 범위 기반 스폰 풀 구성**
  - EnemyCostData에 spawnTimeMin, spawnTimeMax 필드 추가
  - 현재 시간에 따라 스폰 가능한 적 타입 필터링
  - 스폰 풀 갱신 로직

- **예산 누적 시스템**
  - 시간 경과에 따른 예산 자동 증가
  - Phase별 예산 증가율 설정 (10/초 → 25/초)
  - 현재 예산 추적

- **주기적 스폰 체크**
  - 고정 주기(기본 1초)로 스폰 체크 실행
  - 스폰 체크 코루틴 또는 타이머 구현

### 검증 방법
- 시간대별로 올바른 적 타입만 스폰되는지 확인
- 예산이 시간에 따라 올바르게 누적되는지 로그 확인
- 스폰 체크가 설정된 주기대로 실행되는지 확인

---

## Phase 2: 스폰 로직

### 목표
예산 기반 적 선택과 건너뛰기 메커니즘을 구현합니다.

### 구현 항목
- **건너뛰기 시스템**
  - 확률 기반 스폰 건너뛰기 로직
  - 건너뛰기 확률 조정 (0% ~ 50%, 기본 30%)
  - 건너뛸 때 예산 유지

- **강제 스폰 타이머**
  - 마지막 스폰 이후 경과 시간 추적
  - MaxIdleTime 도달 시 강제 스폰
  - 시간에 따른 MaxIdleTime 곡선 적용 (5초 → 2초)

- **예산 기반 적 선택**
  - ProceduralWaveGenerator의 적 선택 로직 재활용
  - 현재 예산 내에서 스폰 가능한 적 가중치 계산
  - 랜덤 선택 후 예산 소모

### 검증 방법
- 건너뛰기 확률이 올바르게 작동하는지 통계 확인
- MaxIdleTime 이후 반드시 스폰되는지 확인
- 예산을 초과하는 적이 선택되지 않는지 확인

---

## Phase 3: 존재 점수 추적

### 목표
현재 화면의 적 난이도를 수치화하고 추적합니다.

### 구현 항목
- **존재 점수 관리**
  - EnemyShip.point를 활용한 존재 점수 합계 계산
  - 적 스폰 시 존재 점수 증가 이벤트
  - 적 파괴 시 존재 점수 감소 이벤트
  - 현재 존재 점수 실시간 추적

- **목표 곡선 정의**
  - 시간별 목표 존재 점수 AnimationCurve 생성
  - 14:00 (50) → 10:00 (150) → 6:00 (400) → 0:00 (800)
  - Phase별 증가 패턴 (선형 → 지수)

- **디버그 UI**
  - 현재 존재 점수 표시
  - 목표 존재 점수 표시
  - 차이율 표시
  - 예산 표시

### 검증 방법
- 적 스폰/파괴 시 존재 점수가 정확히 증감하는지 확인
- 목표 곡선이 시간에 따라 올바르게 작동하는지 확인
- 디버그 UI로 실시간 수치 모니터링

---

## Phase 4: 동적 난이도 조정

### 목표
플레이어 실력에 따라 예산 증가율을 자동 조정합니다.

### 구현 항목
- **연속적인 배율 조정**
  - 공식: `배율 = 목표 존재 점수 / 현재 존재 점수`
  - 매 프레임 실시간 계산
  - 시간 기반 예산 증가율에 배율 곱셈 적용
  - 현재 점수가 목표의 1/N이면 N배 보정 (비율 기반)

- **범위 제한**
  - 예산 증가율 배율: 0.1x ~ 10x (10% ~ 1000%)
  - Mathf.Clamp로 극단적 변화 방지

- **Inspector 설정**
  - `minBudgetRateMultiplier`: 최소 배율 (기본 0.1)
  - `maxBudgetRateMultiplier`: 최대 배율 (기본 10)

### 검증 방법
- 플레이어가 적을 빠르게 처리할 때 (현재 > 목표) 배율 감소 확인 (최소 0.1x)
- 플레이어가 압도당할 때 (현재 < 목표) 배율 증가 확인 (최대 10x)
- 균형 상태에서 (현재 = 목표) 배율 1.0x 확인
- 현재가 목표의 10%일 때 약 10배 보정 확인

---

## Phase 5: 특수 스폰 이벤트

### 목표
Vampire Survivors 스타일의 특정 방향 집중 스폰 이벤트를 구현합니다.

### 구현 항목
- **이벤트 설정 (Inspector)**
  - 이벤트 발동 시간 (초) - **수동 지정**
  - 스폰 방향 (Top/Bottom/Left/Right/Random) - **수동 지정**
  - 스폰할 적 종류와 수량 - **수동 지정**
  - 스폰 간격 (초, 기본 0.2초) - **수동 지정**
  - 일반 스폰 일시 중지 여부 (기본 true)

- **이벤트 트리거 시스템**
  - 경과 시간 체크로 이벤트 발동
  - 이벤트 시작 시 일반 스폰 일시 중지 (옵션)
  - 모든 적 스폰 완료 시 일반 스폰 재개
  - 이벤트 중복 방지 (한 번만 실행)

- **이벤트 스폰 로직**
  - 특정 방향(edge)에서만 스폰
  - 짧은 간격으로 고밀도 스폰 (spawnInterval 사용)
  - enemyComposition에 정의된 순서대로 스폰
  - 모든 수량 소진 시 이벤트 종료

- **예고 시스템**
  - 이벤트 N초 전 경고 (기본 5초)
  - UI 경고 메시지 (옵션)
  - 효과음/진동 (옵션)
  - 스폰 방향 표시 화살표/이펙트 (옵션)

- **이벤트 예시**
  - 3분 (11:00): 상단에서 Enemy_light_child 30마리
  - 7분 (7:00): 랜덤 방향에서 Enemy_mid_master 15마리
  - 11분 (3:00): 좌측에서 Enemy_heavy 5마리 + Enemy_mid 10마리

### 검증 방법
- 설정된 시간에 정확히 이벤트가 발동하는지 확인
- 지정된 방향에서만 스폰되는지 확인
- 지정된 수량만큼 정확히 스폰되는지 확인
- 이벤트 중 일반 스폰이 올바르게 중지/재개되는지 확인
- 예고 시스템이 적절한 타이밍에 작동하는지 확인
- 이벤트가 중복 실행되지 않는지 확인

---

## Phase 6: 밸런싱 & 최적화

### 목표
시스템을 실제 게임플레이에 맞게 조정하고 성능을 최적화합니다.

### 구현 항목
- **플레이테스트**
  - 다양한 플레이어 스킬 레벨로 테스트
  - 게임 페이스가 적절한지 확인
  - 난이도 곡선이 자연스러운지 평가
  - 특수 이벤트 타이밍과 강도 평가

- **파라미터 튜닝**
  - 예산 증가율 조정
  - 건너뛰기 확률 조정
  - 목표 존재 점수 곡선 조정
  - MaxIdleTime 곡선 조정
  - 동적 조정 임계값 및 배율 조정
  - 특수 이벤트 수량, 타이밍, 간격 조정

- **성능 최적화**
  - 적 수량 제한 (최대 300마리)
  - 타입별 개수 제한 옵션
  - 스폰 풀 갱신 빈도 최적화
  - Object Pooling 확인
  - 이벤트 중 고밀도 스폰 최적화

- **보스 통합**
  - 시간 기반 보스 이벤트 (10:00, 5:00, 0:30)
  - 보스 스폰 시 일반 스폰 일시 중지
  - 보스 예고 UI (30초 전)

### 검증 방법
- 프레임레이트 안정성 확인 (특히 이벤트 중)
- 메모리 사용량 모니터링
- 적 수량이 제한 내에 있는지 확인
- 보스 이벤트가 올바른 타이밍에 발생하는지 확인

---

## Phase 7: 폴리싱

### 목표
사용자 경험을 개선하고 시스템을 완성합니다.

### 구현 항목
- **UI/UX 개선**
  - 디버그 UI를 프로덕션 UI로 전환 (옵션)
  - 스폰 예고 효과 (시각/청각)
  - 난이도 변화 피드백

- **피드백 강화**
  - 적 스폰 시 효과음/파티클
  - Phase 전환 알림
  - 보스 등장 연출

- **문서화**
  - 최종 파라미터 값 문서화
  - 밸런싱 가이드 작성
  - 시스템 사용법 정리

### 검증 방법
- 사용자 테스트로 피드백 수집
- 모든 기능이 문서화되었는지 확인

---

## 주요 고려사항

**기존 시스템 재활용**:
- ✅ EnemyCostData 구조 확장
- ✅ ProceduralWaveGenerator 적 선택 로직 활용
- ✅ EnemySpawner 스폰 실행 유지
- ✅ EnemyShip.point 활용

**제거/변경 필요**:
- ❌ WaveSystem의 수동 진행 로직 제거
- ❌ GeneratedWaveData의 SpawnInfo 배열 제거
- ⚠️ 보스 시스템을 시간 기반으로 변경

**성능 주의**:
- 매 프레임 계산 최소화
- 스폰 풀 캐싱
- 이벤트 기반 존재 점수 갱신

---

## 문서 정보
- **작성일**: 2026-01-20
- **최종 수정**: 2026-01-22
- **버전**: 1.1
