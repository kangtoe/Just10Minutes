# 시간 기반 예산 스폰 시스템

> **설계 목표**
>
> - Vampire Survivors 스타일의 지속적인 압박감 제공
> - 절차적 생성으로 밸런싱 유연성 유지
> - 동적 난이도 조정으로 플레이어 실력에 맞춤
> - 시간 기반 자동 진행으로 예측 가능한 게임 페이스 보장

## 핵심 요구사항

1. 적은 종류마다 스폰 하한과 상한 시간을 가지고 있습니다. 해당 시간 내에서만 스폰됩니다. 이걸로 현재 스폰 가능한 적 종류에 대한 스폰 풀을 구성합니다.
2. 시간이 흐름에 따라 스폰 예산이 쌓입니다. 시간이 경과 될수록 예산이 쌓이는 속도가 빨라집니다.
3. 일정 주기마다, 스폰 체크를 수행합니다. 스폰 체크의 결과는 스폰 할 적 종류를 알아오는 것입니다.
4. 적을 스폰하지 않을 확률도 존재합니다. 이 경우 예산은 소모 되지 않겠습니다. (의도는 더 강한 적 종류를 스폰할 수 있게 하는 것입니다.)
5. 그러나 스폰하지 않는 시간에는 한계가 있습니다. 일정시간 스폰하지 않았다면, 다음 체크때는 반드시 하나 이상의 적을 스폰해야 합니다.
6. 스폰체크에서 적을 스폰하기로 했다면, 현재 예산 내에서 풀에 해당하는 적 종류 중 하나를 골라야 합니다.
7. 적을 스폰과 파괴 시 존재 점수 합계를 증감합니다. 즉 존재 점수 합계란, 현존하는 모든 적의 점수의 합입니다.
8. 시간에 따른 목표 존재 점수 합계를 올립니다.
9. 목표보다 현재 존재점수 합계가 너무 낮다면 스폰 주기와 스폰 예산을 올리고, 반대의 경우는 내립니다.

---

## 핵심 설계 철학

기존 웨이브 기반 시스템의 장점(예산 기반 절차적 생성)을 유지하면서, Vampire Survivors 및 20 Minutes Till Dawn의 시간 기반 스폰 메커니즘을 결합한 **하이브리드 시스템**

| 요소 | 기존 시스템 | 새 시스템 |
|------|-----------|---------|
| **진행 방식** | 수동 (적 전멸 시) | 자동 (시간 기반) |
| **스폰 타이밍** | 웨이브 시작 시 1회 | 주기적 체크로 계속 스폰 |
| **적 선택** | 예산으로 조합 생성 | 시간 범위 + 예산 |
| **난이도 조정** | 고정 (웨이브별 예산) | 동적 (존재 점수 기반) |
| **게임 종료** | 웨이브 30 클리어 | 시간 제한 |

---

## 시스템 구성 요소

### 1. 시간 범위 기반 스폰 풀

각 적 타입은 스폰 가능한 시간 범위를 가지며, 해당 범위 내에서만 스폰됩니다.

**예시**:
- Light Fighter: 14:00 ~ 10:00
- Medium Bomber: 12:00 ~ 6:00
- Heavy Battleship: 8:00 ~ 0:00

시간에 따라 스폰 가능한 적 타입이 자동으로 변화하여 자연스러운 난이도 증가를 제공합니다.

---

### 2. 시간 기반 예산 누적

시간이 흐르면 스폰 예산이 자동으로 누적되며, 게임 경과 시간에 따라 누적 속도가 점점 빨라집니다.

- 초기 예산: 50
- 증가율: 10/초 ~ 25/초 (Phase에 따라 증가)
- Phase 1(14:00~10:00) → Phase 2(10:00~6:00) → Phase 3(6:00~0:00)

---

### 3. 주기적 스폰 체크

일정 주기마다 스폰 체크를 수행합니다.
1. 건너뛰기 판정 (확률 기반)
2. 스폰 풀에서 적 타입 선택
3. 예산 소모 및 스폰 실행
4. 존재 점수 갱신

- 체크 주기: 0.5초 ~ 3.0초 (동적 조정, 기본값: 1초)

---

### 4. 스폰 건너뛰기

스폰 체크 시 일정 확률로 스폰하지 않아 예산을 축적하고, 이후 더 강한 적을 스폰할 수 있습니다.

- 건너뛰기 확률: 0% ~ 50% (기본값: 30%, 상황에 따라 ±20% 조정)
- 예산 부족 시 확률 증가 (축적 유도)
- 압박 부족 시 확률 감소 (스폰 강제)
- 압박 과다 시 확률 증가 (스폰 대기)

---

### 5. 최대 대기 시간 제한

스폰하지 않고 대기한 시간을 추적하여, 일정 시간 이상 스폰하지 않으면 강제 스폰합니다.

- 최대 대기 시간: 2초 ~ 5초 (시간에 따라 감소)
  - 게임 시작(14:00): 5초
  - 중반(7:00): 3.5초
  - 게임 종료(0:00): 2초

무한 건너뛰기 방지 및 시간에 따라 게임 페이스 점진적 증가

---

### 6. 예산 기반 적 선택

스폰 체크 시 현재 예산 내에서 스폰 가능한 적을 가중치 기반으로 랜덤 선택합니다.

- 가중치 예시: Light 1.0, Medium 0.8, Heavy 0.5
- 비용이 높을수록 출현 확률 감소
- 기존 ProceduralWaveGenerator의 적 선택 로직 재활용

---

### 7. 존재 점수 추적

현재 화면에 존재하는 모든 적의 점수 합계를 추적합니다.

- 적의 존재 점수 = EnemyShip.point
- 적 스폰 시 증가, 파괴 시 감소
- 현재 게임 난이도를 수치화

---

### 8. 목표 존재 점수 곡선

시간에 따른 목표 존재 점수를 정의하여 게임이 유지해야 할 난이도 기준선을 제공합니다.

- 곡선 예시:
  - 14:00 (Phase 1 시작): 50
  - 10:00 (Phase 2 시작): 150
  - 6:00 (Phase 3 시작): 400
  - 0:00 (게임 종료): 800

- Phase 1: 선형 증가
- Phase 2~3: 지수 증가

---

### 9. 동적 난이도 조정

현재 존재 점수와 목표 존재 점수를 비교하여 스폰 주기와 예산 증가율을 동적으로 조정합니다.

- 조정 주기: 5초마다
- 조정 임계값: ±20%
- 조정 배율: 0.9 ~ 1.1
- 변화 속도: Lerp 0.1 (부드러운 전환)

**범위 제한**:
- 스폰 주기: 0.5초 ~ 3.0초
- 예산 증가율: 기본값의 70% ~ 130%

**조정 로직**:

차이율 = (현재 존재 점수 - 목표 존재 점수) / 목표 존재 점수

1. **차이율 ±20% 이내**: 조정 없음
2. **차이율 < -20%**: 스폰 주기 감소, 예산 증가율 증가
3. **차이율 > +20%**: 스폰 주기 증가, 예산 증가율 감소

---

## 시스템 장점

- **예측 가능성**: 시간별 적 타입 제어로 게임 페이스 설계 가능
- **유연성**: 절차적 생성으로 매 플레이 다른 조합
- **자연스러운 난이도**: 예산/풀/목표 증가로 점진적 압박
- **자기 조절**: 플레이어 실력에 따른 동적 난이도 조정
- **개발 효율**: 기존 시스템 재활용, 파라미터 조정으로 밸런싱

---

## 주요 고려사항

**동적 조정**: 조정 범위 제한(±30%), 부드러운 변화(Lerp), 임계값 설정(±20%)으로 급격한 변화 방지

**건너뛰기**: 시간에 따른 MaxIdleTime 감소(5초→2초)로 게임 페이스 보장

**적 수량 제한**: 최대 300마리, 타입별 개수 제한 옵션으로 성능 및 가독성 유지

**시간 범위 전환**: 겹치는 시간 범위 설계로 스폰 풀 급변 방지

**보스 통합**: 시간 기반 보스 이벤트(10:00, 5:00, 0:30), 보스 예고 UI(30초 전)

---

## 구현

구현 계획은 별도 문서를 참고하세요:
- [구현 단계 (Phases)](Phases.md)

---

## 기존 시스템과의 호환성

**유지**:
- ✅ EnemyCostData (적 비용 데이터)
- ✅ ProceduralWaveGenerator (적 선택 로직)
- ✅ EnemySpawner (스폰 실행)
- ✅ EnemyShip.point (존재 점수)

**변경/제거**:
- ❌ WaveSystem (수동 진행 제거)
- ❌ GeneratedWaveData (SpawnInfo 배열 제거)
- ⚠️ 보스 시스템 (시간 기반 이벤트로 변경)

---

## 참고 자료

### 내부 문서
- [EnemySpawnScaling.md](EnemySpawnScaling.md) - 적 스탯 스케일링 시스템

### 참고 문서
- [Vampire Survivors 스폰 시스템 분석](../../References/VampireSurvivors_SpawnSystem.md)

### 외부 자료
- [Vampire Survivors Wiki - Timed Enemy Spawn](https://vampire-survivors.fandom.com/wiki/Timed_Enemy_Spawn)
- [20 Minutes Till Dawn - Spawner](https://20-minutes-till-dawn.fandom.com/wiki/Spawner)
