# 절차적 웨이브 생성 시스템

> Nova Drift 스타일의 동적 난이도 조절과 예측 불가능한 플레이 경험

## 개요

AutoSpaceShooter의 웨이브 시스템을 **수작업 설계**에서 **절차적 생성**으로 확장하여 다음을 달성합니다:

**목표**:
- 매 플레이마다 다른 적 조합과 배치
- 자동 난이도 조절로 밸런싱 부담 감소
- 무한한 리플레이 가치
- 플레이어 빌드에 반응하는 동적 챌린지

**접근 방식**:
- 튜토리얼 웨이브(1-5): 수작업 설계
- 보스 웨이브(10, 20, 30): 수작업 설계
- 일반 웨이브(6-9, 11-19, 21-29): 절차적 생성

## Nova Drift 참조

### 핵심 메커니즘
Nova Drift의 절차적 생성은 7단계 프로세스로 구성됩니다:

1. **예산 계산**: 웨이브 번호 기반 적 스폰 예산 설정
2. **스폰 타입 선택**: 22가지 스폰 패턴 중 선택
3. **적 조합 결정**: 예산 내에서 적 종류와 수량 결정
4. **배치 패턴**: 원형, 직선, 산개 등 배치 결정
5. **타이밍 조절**: 스폰 간격과 순서 결정
6. **보정**: 너무 쉽거나 어려우면 조정
7. **검증**: 플레이 가능한지 최종 확인

**스폰 타입 예시**:
- 단일 강적 (Single Elite)
- 소형 무리 (Small Swarm)
- 포위 공격 (Encirclement)
- 파동 공격 (Wave Assault)
- 혼합 편대 (Mixed Squadron)

### 난이도 스케일링
- 웨이브 120까지 절차적 생성
- 웨이브 120 이후 엔드리스 모드
- 플레이어 레벨과 독립적인 웨이브 진행

## 예산 기반 스폰 시스템

### 웨이브 예산 공식

```
웨이브 예산 = BasePoints + (WaveNumber * GrowthRate)

BasePoints = 100     // 초기 예산
GrowthRate = 50      // 웨이브당 증가량

예시:
웨이브 1:  150 포인트
웨이브 5:  350 포인트
웨이브 10: 600 포인트
웨이브 20: 1100 포인트
웨이브 30: 1600 포인트
```

### 적 비용 테이블

| 등급 | 대표 적 | 비용 | 설명 |
|------|---------|------|------|
| Light | child, kido, thunder | 20-30 | 기본 필러 적 |
| Light+ | shield | 40 | 고체력 경량 |
| Mid | Ghost, Hornet | 80-100 | 표준 중형 |
| Mid+ | Knight, Spiral, tank | 120-150 | 강화 중형 |
| Heavy | mother, Gunship | 300-400 | 위협적 대형 |
| Boss | Boss | 1500 | 웨이브 전체 예산 |

**비용 설정 원칙**:
- 점수가 높을수록 비용 증가
- 특수 능력(사격, 소환)은 비용 가중치 +20-50%
- 플레이어가 회피하기 어려운 패턴은 비용 증가

### 예산 사용 예시

```
웨이브 5 (예산 350):
시나리오 A: Hornet × 3 (90×3=270) + thunder × 2 (20×2=40) = 310
시나리오 B: tank × 2 (120×2=240) + kido × 4 (20×4=80) = 320
시나리오 C: Ghost × 4 (80×4=320) = 320

웨이브 15 (예산 850):
시나리오 A: mother × 1 (400) + Hornet × 4 (90×4=360) = 760
시나리오 B: Knight × 3 (150×3=450) + Spiral × 2 (120×2=240) + shield × 3 (40×3=120) = 810
시나리오 C: Gunship × 2 (300×2=600) + Ghost × 3 (80×3=240) = 840
```

## 스폰 패턴 템플릿
햕
### 1. 소형 무리 (Small Swarm)
**특징**: 다수의 약한 적

**조건**:
- 예산의 70% 이상을 Light 등급에 사용
- 최소 5마리 이상

**배치**:
- Edge: Random 또는 Up
- 스폰 간격: 0.2-0.5초

**위협도**: ▁▂

**예산 사용 예시**:
```
웨이브 8 (예산 500):
child × 10 (20×10=200) + thunder × 8 (25×8=200) = 400
→ 빠른 간격으로 산개 스폰
```

### 2. 중형 편대 (Mid Squadron)
**특징**: 중형 적 중심 구성

**조건**:
- Mid 등급 3-6마리
- 선택적으로 Light 보조 추가

**배치**:
- Edge: Up/Down/Left/Right (1-2개 방향)
- 스폰 간격: 0.5-1.5초

**위협도**: ▂▃

**예산 사용 예시**:
```
웨이브 12 (예산 700):
Hornet × 4 (90×4=360) + Ghost × 3 (80×3=240) = 600
→ 2개 방향에서 교차 스폰
```

### 3. 엘리트 + 호위 (Elite + Escort)
**특징**: 1-2개 강한 적 + 약한 적들

**조건**:
- Heavy 또는 Mid+ 1-2마리 (예산의 40-60%)
- Light 다수로 호위

**배치**:
- 엘리트: Up (중앙)
- 호위: Left/Right (측면)
- 엘리트가 먼저 스폰, 호위는 2-3초 후

**위협도**: ▃▄

**예산 사용 예시**:
```
웨이브 18 (예산 1000):
mother × 1 (400) [Up, 0초]
+ tank × 3 (120×3=360) [Left, 2초, 간격 1초]
+ shield × 5 (40×5=200) [Right, 2초, 간격 0.5초]
= 960
```

### 4. 포위 공격 (Encirclement)
**특징**: 3-4개 방향에서 동시 공격

**조건**:
- 최소 3개 스폰 그룹
- 각 그룹 동시 또는 0.5초 이내 스폰

**배치**:
- Edge: Up/Down/Left/Right (3-4개)
- 스폰 간격: 동시 스폰 또는 0.3초

**위협도**: ▄▅

**예산 사용 예시**:
```
웨이브 22 (예산 1200):
그룹 A: Spiral × 2 (120×2=240) [Up, 0초]
그룹 B: Knight × 2 (150×2=300) [Down, 0초]
그룹 C: Ghost × 4 (80×4=320) [Left, 0.5초]
그룹 D: thunder × 10 (25×10=250) [Right, 0.5초]
= 1110
```

### 5. 파동 공격 (Wave Assault)
**특징**: 여러 스폰 그룹으로 나누어 연속 공격

**조건**:
- 예산을 2-3개 스폰 그룹으로 분할
- 각 그룹 간격 3-5초

**배치**:
- 첫 번째 그룹: Light 중심
- 두 번째 그룹: Mid 중심
- 세 번째 그룹: Heavy 또는 Mid+

**위협도**: ▃▄▅

**예산 사용 예시**:
```
웨이브 25 (예산 1350):
그룹 1 (0초): child × 15 (20×15=300) + kido × 5 (20×5=100) = 400
그룹 2 (4초): Hornet × 3 (90×3=270) + Spiral × 2 (120×2=240) = 510
그룹 3 (8초): Gunship × 1 (300) + tank × 2 (120×2=240) = 540
총합: 1450 (약간 초과는 허용)
```

### 6. 보스 웨이브 (Boss Wave)
**특징**: 고정 설계, 수작업 제작

**조건**:
- 웨이브 5, 10, 20, 30
- 절차적 생성 대신 프리셋 사용

**위협도**: ▅▅▅

**예시**:
```
웨이브 10:
Boss × 1 [Up, 0초]
+ Hornet × 4 [Random, 5초, 간격 1초] (보스 체력 50% 이하 시)
```

## 패턴 선택 메커니즘

### 웨이브 단계별 패턴 분포

**초반 웨이브 (1-5)**:
- 소형 무리: 60%
- 중형 편대: 40%

**중반 웨이브 (6-15)**:
- 소형 무리: 30%
- 중형 편대: 40%
- 엘리트+호위: 30%

**후반 웨이브 (16-25)**:
- 중형 편대: 20%
- 엘리트+호위: 40%
- 포위 공격: 30%
- 파동 공격: 10%

**최종 웨이브 (26-29)**:
- 엘리트+호위: 30%
- 포위 공격: 40%
- 파동 공격: 30%

### 다양성 보장 규칙

1. **같은 패턴 3회 연속 금지**: 최근 패턴 확률 50% 감소
2. **같은 Edge 2회 연속 제한**: Up → Down, Left → Right 순환
3. **같은 적 종류 4회 연속 제한**: 주요 적 종류 추적 및 회피
4. **최근 5개 웨이브 기록**: 패턴/Edge/적 종류 히스토리 유지

## 난이도 조절

### 플레이어 성능 기반 조절

**추적 지표**:
1. **평균 웨이브 클리어 시간**: 최근 3개 웨이브 평균
2. **받은 피해량**: 최근 3개 웨이브 누적 피해
3. **사망 횟수**: 현재 런에서 사망 횟수

**예산 배율 조정**:
- **기본 배율**: 1.0 (100%)
- **빠른 클리어** (20초 미만): +15%
- **피해 적음** (50 미만): +10%
- **사망 발생**: -20% (사망당)
- **조정 범위**: 0.7 ~ 1.3 (70% ~ 130%)

**의도**:
- 숙련 플레이어: 점진적 난이도 증가로 도전 유지
- 초보 플레이어: 난이도 완화로 좌절 방지
- 사망 시 일시적 난이도 하락으로 재도전 기회

### 빌드 카운터 시스템

**고화력 빌드** (멀티샷 + 발사체 데미지):
- 대응: Heavy 적 비율 증가, 분산 배치, HP 높은 적 선호

**탱커 빌드** (최대 실드 + 충돌 피해):
- 대응: 원거리 사격 적 증가, 포위 패턴, 거리 유지형 적 선호

**기동 빌드** (이동 속도 + 회전 속도):
- 대응: 유도 공격, 다방향 사격, 영역 제한 패턴 (포위 공격)

## 구현 우선순위

### 1단계: 기본 생성 (필수)

**핵심 기능**:
- 웨이브 예산 계산 시스템
- 적 비용 테이블 설정
- 1개 패턴 동작 (소형 무리)
- 기존 웨이브 시스템과 통합

**목표**:
- 웨이브 6부터 절차적 생성 적용
- 예산 초과 없이 정상 스폰

### 2단계: 패턴 다양화 (필수)

**핵심 기능**:
- 6가지 패턴 모두 구현
- 패턴 선택 가중치 시스템
- 다양성 보장 (중복 방지)

**목표**:
- 각 패턴이 균등하게 등장
- 연속 중복 없음
- 웨이브마다 신선한 경험

### 3단계: 난이도 조절 (권장)

**핵심 기능**:
- 플레이어 성능 추적
- 예산 배율 동적 조정
- 빌드 감지 및 카운터

**목표**:
- 숙련도에 따른 자동 밸런싱
- 초보/고수 모두 적절한 도전

### 4단계: 고급 기능 (선택)

**확장 요소**:
- 특수 이벤트 웨이브 (보너스, 챌린지)
- 시드 기반 생성 (일일 챌린지)
- 생성 히스토리 및 리플레이
- 빌드 카운터 고도화

**목표**:
- Nova Drift 수준 완성도
- 장기 플레이 가치

## 밸런싱 파라미터

### 예산 설정

| 파라미터 | 기본값 | 설명 |
|---------|--------|------|
| basePoints | 100 | 초기 예산 |
| growthRate | 50 | 웨이브당 증가량 |
| minBudgetMultiplier | 0.7 (70%) | 최소 난이도 배율 |
| maxBudgetMultiplier | 1.3 (130%) | 최대 난이도 배율 |

### 다양성 설정

| 파라미터 | 기본값 | 설명 |
|---------|--------|------|
| patternHistorySize | 5 | 최근 패턴 기록 수 |
| recentPatternPenalty | 0.5 (50%) | 최근 패턴 확률 감소 |

### 난이도 조절 설정

| 파라미터 | 기본값 | 설명 |
|---------|--------|------|
| fastClearThreshold | 20초 | 빠른 클리어 기준 |
| fastClearBonus | +0.15 | 빠른 클리어 시 난이도 증가 |
| lowDamageBudgetBonus | +0.1 | 피해 적을 때 난이도 증가 |
| deathPenalty | -0.2 | 사망 시 난이도 감소 |

### 웨이브별 권장 예산

| 웨이브 범위 | 예산 범위 | 주요 적 등급 | 패턴 |
|------------|----------|-------------|------|
| 1-5 | 150-350 | Light 중심 | SmallSwarm |
| 6-10 | 400-600 | Light + Mid | SmallSwarm, MidSquadron |
| 11-15 | 650-850 | Mid 중심 | MidSquadron, EliteEscort |
| 16-20 | 900-1100 | Mid + Heavy | EliteEscort, Encirclement |
| 21-25 | 1150-1350 | Mid+ + Heavy | Encirclement, WaveAssault |
| 26-29 | 1400-1550 | Heavy 중심 | Encirclement, WaveAssault |
| 30 | 1600+ | Boss | 수작업 설계 |

## 수작업 vs 절차적 하이브리드

### 수작업 웨이브

**웨이브 1-5 (튜토리얼)**:
- 목적: 게임 메커니즘 학습
- 난이도: 매우 쉬움 → 쉬움
- 설계: 예측 가능한 패턴

**웨이브 10, 20, 30 (보스)**:
- 목적: 마일스톤 및 성취감
- 난이도: 급격히 높음
- 설계: 독특한 메커니즘

**특수 웨이브 (선택)**:
- 웨이브 15: 미니 보스 또는 특수 이벤트
- 웨이브 25: 최종 보스 전 챌린지

### 절차적 웨이브

**웨이브 6-9, 11-19, 21-29**:
- 목적: 다양성과 리플레이 가치
- 난이도: 점진적 증가 + 동적 조절
- 설계: 알고리즘 기반

### 웨이브 타입 결정 우선순위

1. **보스 웨이브** (10, 20, 30): 수작업 프리셋
2. **튜토리얼** (1-5): 수작업 프리셋
3. **특수 이벤트** (6-29 중 10% 확률): 보너스/챌린지 웨이브
4. **절차적 생성** (나머지): 알고리즘 기반 생성

## 테스트 및 검증

### 자동화 테스트

**예산 검증**:
- 모든 웨이브의 적 비용 합이 예산 ±10% 이내
- 예산 초과 시 경고 로그

**다양성 검증**:
- 100개 웨이브 생성 후 패턴 분포 분석
- 각 패턴이 15% 이상 등장하는지 확인
- 3회 연속 동일 패턴 없는지 확인

**난이도 곡선 검증**:
- 시뮬레이션으로 30분 플레이 재현
- 평균 레벨 10-15 도달 확인
- 웨이브 25-30 도달 확인

### 플레이 테스트

**체크리스트**:
- [ ] 30분 플레이 시 지루하지 않은가?
- [ ] 각 웨이브가 독특하게 느껴지는가?
- [ ] 난이도 급등/급락이 없는가?
- [ ] 특정 빌드가 너무 유리하지 않은가?
- [ ] 보스 웨이브 전에 준비 시간이 있는가?

**데이터 수집**:
- 웨이브별 클리어 시간
- 웨이브별 받은 피해
- 가장 위협적인 적 종류
- 가장 자주 등장한 패턴

## 향후 확장

### 시즌별 테마
- 특정 적 종류 강화 시즌
- 특수 이벤트 웨이브 추가
- 계절별 난이도 조정

### 일일 챌린지
- 고정 시드 기반 생성
- 글로벌 리더보드
- 특수 보상

### 커스텀 모드
- 플레이어가 예산/패턴 설정
- 특정 적만 나오는 모드
- 극한 난이도 모드

## 기존 시스템과의 연동

### 통합 지점

**EnemySpawner**: 웨이브 시작 시 수작업/절차적 생성 분기
- 보스/튜토리얼: 프리셋 웨이브 로드
- 일반 웨이브: 절차적 생성기 호출

**PlayerStats**: 빌드 감지를 위한 스탯 참조
- 멀티샷, 발사체 데미지, 최대 실드, 충돌 피해, 이동 속도 등

**LevelManager**: 난이도 조절을 위한 성능 추적
- 웨이브 클리어 시간, 받은 피해 기록

## 참고

- [WaveSystem.md](WaveSystem.md): 웨이브 시스템 기본 구조
- [EnemyList.md](EnemyList.md): 적 비용 설정 참조
- [EnemyAI.md](EnemyAI.md): AI 패턴과 조합
- [PlayerLevelSystem.md](PlayerLevelSystem.md): 난이도 밸런싱 참조
- [GameDesignOverview.md](GameDesignOverview.md): 전체 게임 디자인
